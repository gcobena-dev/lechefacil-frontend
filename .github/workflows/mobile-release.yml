name: Mobile Release

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Current version: $VERSION"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Check if version changed
        id: check
        env:
          S3_MOBILE_BUCKET: ${{ secrets.S3_MOBILE_BUCKET }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if version.json exists in S3
          if aws s3 ls "s3://${S3_MOBILE_BUCKET}/version.json" 2>/dev/null; then
            # Download and extract last deployed version
            aws s3 cp "s3://${S3_MOBILE_BUCKET}/version.json" /tmp/version.json
            LAST_VERSION=$(node -p "require('/tmp/version.json').version")
            echo "ðŸ“‹ Last deployed version: $LAST_VERSION"

            if [ "$VERSION" == "$LAST_VERSION" ]; then
              echo "changed=false" >> "$GITHUB_OUTPUT"
              echo "â­ï¸  Version $VERSION already deployed, skipping build"
              exit 0
            else
              echo "changed=true" >> "$GITHUB_OUTPUT"
              echo "âœ… Version changed from $LAST_VERSION to $VERSION"
            fi
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "âœ… First deployment, version $VERSION"
          fi

      - name: Setup Node.js
        if: steps.check.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 21
        if: steps.check.outputs.changed == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install dependencies
        if: steps.check.outputs.changed == 'true'
        run: npm ci

      - name: Build production app
        if: steps.check.outputs.changed == 'true'
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Sync Capacitor
        if: steps.check.outputs.changed == 'true'
        run: npx cap sync android

      - name: Setup release signing
        if: steps.check.outputs.changed == 'true'
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'lechefacil123' }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || 'lechefacil123' }}
        run: |
          # Generate keystore
          echo "ðŸ” Generating release keystore..."
          keytool -genkey -v \
            -keystore android/app/release.keystore \
            -alias lechefacil \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass "${KEYSTORE_PASSWORD}" \
            -keypass "${KEY_PASSWORD}" \
            -dname "CN=LecheFacil, OU=Mobile, O=LecheFacil, L=City, S=State, C=US"

          # Create key.properties for Gradle
          cat > android/key.properties <<EOF
          storePassword=${KEYSTORE_PASSWORD}
          keyPassword=${KEY_PASSWORD}
          keyAlias=lechefacil
          storeFile=release.keystore
          EOF

      - name: Build signed APK
        if: steps.check.outputs.changed == 'true'
        run: |
          cd android
          chmod +x ./gradlew
          ./gradlew assembleRelease

      - name: List APK outputs (debug)
        if: steps.check.outputs.changed == 'true'
        run: |
          echo "ðŸ“‹ Listing APK output directory:"
          find android/app/build/outputs/apk -type f -name "*.apk" || echo "No APKs found"

      - name: Upload to S3
        if: steps.check.outputs.changed == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          S3_MOBILE_BUCKET: ${{ secrets.S3_MOBILE_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          # Find the release APK (might be app-release-unsigned.apk or app-release.apk)
          APK=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)

          if [ -z "$APK" ]; then
            echo "âŒ No APK found in android/app/build/outputs/apk/release/"
            exit 1
          fi

          echo "ðŸ“¦ Found APK: $APK"
          echo "ðŸ“¤ Uploading APK version ${VERSION} to S3..."

          # Upload versioned APK
          aws s3 cp "$APK" \
            "s3://${S3_MOBILE_BUCKET}/lechefacil-${VERSION}.apk" \
            --content-type application/vnd.android.package-archive

          # Upload latest (overwrite)
          aws s3 cp "$APK" \
            "s3://${S3_MOBILE_BUCKET}/lechefacil-latest.apk" \
            --content-type application/vnd.android.package-archive

          # Create update bundle
          echo "ðŸ“¦ Creating update bundle..."
          cd dist && zip -r ../update.zip . && cd ..
          aws s3 cp update.zip \
            "s3://${S3_MOBILE_BUCKET}/updates/${VERSION}.zip"

          # Generate version.json
          echo "ðŸ“ Generating version.json..."
          cat > version.json <<EOF
          {
            "version": "${VERSION}",
            "versionCode": ${{ github.run_number }},
            "apkUrl": "https://${S3_MOBILE_BUCKET}.s3.${AWS_REGION}.amazonaws.com/lechefacil-${VERSION}.apk",
            "latestApkUrl": "https://${S3_MOBILE_BUCKET}.s3.${AWS_REGION}.amazonaws.com/lechefacil-latest.apk",
            "updateBundleUrl": "https://${S3_MOBILE_BUCKET}.s3.${AWS_REGION}.amazonaws.com/updates/${VERSION}.zip",
            "releaseDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "minVersion": "0.0.1",
            "changelog": "Release ${VERSION}"
          }
          EOF

          aws s3 cp version.json \
            "s3://${S3_MOBILE_BUCKET}/version.json" \
            --content-type application/json \
            --cache-control "no-cache, must-revalidate"

          echo "âœ… Successfully deployed version ${VERSION}"
          echo "ðŸ“± APK: https://${S3_MOBILE_BUCKET}.s3.${AWS_REGION}.amazonaws.com/lechefacil-${VERSION}.apk"
